<?php namespace themeDevSocialNext\Providers;use \themeDevSocialNext\Providers\Abst\Abstractnext as Abstractnext;use \themeDevSocialNext\Providers\Abst\Util as Util;use \themeDevSocialNext\Providers\Abst\Curl as Curl;class Instagram extends Abstractnext{protected $api_key='';protected $api_secret='';private $access_token='';private $access_code='';protected $apiBaseUrl='https://api.instagram.com/v1/';protected $authorizeUrl='https://api.instagram.com/oauth/authorize';protected $accessTokenUrl='https://api.instagram.com/oauth/access_token';protected $apiDocumentation='https://www.instagram.com/developer/authentication/';protected $profileUrlTemplate='https://www.instagram.com/%s';protected $scope='';protected $callback='';protected $fields='';private $nx_connected=false;private $profile_data='';private $curl;public function __construct($config){if(is_array($config)){$this->api_key=isset($config['keys']['id'])?$config['keys']['id']:'';$this->api_secret=isset($config['keys']['secret'])?$config['keys']['secret']:'';$this->callback=isset($config['callback'])?$config['callback']:'';$this->curl=new Curl();}}public function nx_authorise(){if(isset($_GET['code'])){$this->get_access_token();}else if(isset($_GET['error'])){return $_GET['error'];}else{$params=['response_type'=>'code','client_id'=>$this->api_key,'scope'=>'basic','redirect_uri'=>$this->callback,];$url=$this->authorizeUrl.'?'.http_build_query($params);Util::redirect($url);}}protected function get_access_token(){$this->access_code=isset($_GET['code'])?$_GET['code']:'';if(strlen($this->access_code)>1){$credentials=$this->api_key.':'.$this->api_secret;$toSend=base64_encode($credentials);$header=['Authorization'=>'Basic '.$toSend,'Content-Type'=>'application/x-www-form-urlencoded;charset=UTF-8'];$body=['grant_type'=>'authorization_code','code'=>$this->access_code,'client_id'=>$this->api_key,'client_secret'=>$this->api_secret,'redirect_uri'=>$this->callback];$reoponse=$this->curl->request($this->accessTokenUrl,'POST',$body,$header);$reoponse=@json_decode($reoponse,true);if(isset($reoponse['access_token'])){$this->access_token=$reoponse['access_token'];$this->nx_connected=true;$this->get_api_data();}else{echo isset($reoponse['error_message'])?$reoponse['error_message']:'';}}}protected function get_api_data(){if(strlen($this->access_token)>5){$header=['Authorization'=>sprintf('Bearer %s',$this->access_token),'Content-Type'=>'application/json',];$body=[];try{$url=$this->apiBaseUrl.'users/self/?access_token='.$this->access_token;$reoponse=$this->curl->request($url,'GET',$body,$header);$reoponse=@json_decode($reoponse,true);if(isset($reoponse['data']['id'])&&strlen($reoponse['data']['id'])>0){$reoponse=isset($reoponse['data'])?$reoponse['data']:[];$userProfile=new \stdClass();$userProfile->identifier=strlen($reoponse['id'])?$reoponse['id']:substr(md5(microtime()),rand(0,26),10);$userProfile->firstName=isset($reoponse['full_name'])?$reoponse['full_name']:'';$userProfile->lastName=isset($reoponse['username'])?$reoponse['username']:'';$userProfile->displayName=isset($reoponse['full_name'])?$reoponse['full_name']:'';$userProfile->email=$userProfile->lastName;$userProfile->description=isset($reoponse['bio'])?$reoponse['bio']:'';$userProfile->emailVerified=true;$userProfile->photoURL=isset($reoponse['profile_picture'])?$reoponse['profile_picture']:'';$userProfile->webSiteURL=isset($reoponse['website'])?$reoponse['website']:'';$userProfile->gender='';$userProfile->language='';$profileUrl=sprintf($this->profileUrlTemplate,$userProfile->lastName);$userProfile->profileURL=$profileUrl;$userProfile->region='';$userProfile->data['media']=isset($reoponse['counts']['media'])?$reoponse['counts']['media']:0;$userProfile->data['follows']=isset($reoponse['counts']['follows'])?$reoponse['counts']['follows']:0;$userProfile->data['followed_by']=isset($reoponse['counts']['followed_by'])?$reoponse['counts']['followed_by']:0;$this->profile_data=$userProfile;}else{$this->profile_data=' Sorry could\'t found profile information.';}}catch(Exception $e){$this->profile_data='Sorry api error';}}else{$this->profile_data='Invalid Accexx Token';}return $this->profile_data;}public function is_connected(){return $this->nx_connected;}public function getUserProfile(){return $this->profile_data;}public function getAccessToken(){return $this->access_token;}public function getAccessCode(){return $this->access_code;}public function getUser($access_token=''){$this->access_token=$access_token;return $this->get_api_data();}}